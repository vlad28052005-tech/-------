<!doctype html>
<html lang="uk">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–†–æ–∑–∫–ª–∞–¥ ‚Äî 4 –∫—É—Ä—Å, –≥—Ä—É–ø–∞ –í</title>
    <meta name="theme-color" content="#0ea5e9" />
    <link rel="apple-touch-icon" href="icon.png" />
    <style>
         :root {
            --bg: #0b1220;
            --panel: #0e1726;
            --text: #e5eefb;
            --muted: #a9b8d5;
            --accent: #0ea5e9;
            --card: #0f172a;
            --border: #1f2a44;
            --lec: #3b82f6;
            --prac: #facc15;
            --green: #16a34a;
            --anim-ms: 360ms;
        }
        
        [data-theme="light"] {
            --bg: #f8fafc;
            --panel: #fff;
            --text: #0b1220;
            --muted: #54627a;
            --card: #fff;
            --border: #e2e8f0;
        }
        
        * {
            box-sizing: border-box
        }
        
        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font: 15px/1.4 system-ui, -apple-system, 'Segoe UI', Roboto, Inter, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .wrap {
            max-width: 1150px;
            margin: 0 auto;
            padding: 12px
        }
        /* Topbar */
        
        .topbar {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, var(--bg) 95%, transparent);
            padding: 10px 0;
            z-index: 40
        }
        
        .brand {
            font-weight: 800
        }
        
        .muted {
            color: var(--muted);
            font-size: 13px
        }
        /* controls */
        
        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--panel);
            padding: 6px;
            border-radius: 10px;
            border: 1px solid var(--border)
        }
        
        .btn {
            border: 1px solid var(--border);
            background: var(--panel);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform .14s ease, box-shadow .18s ease, background .18s ease;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(2, 8, 23, .25)
        }
        
        .btn:active {
            transform: translateY(-1px) scale(.99)
        }
        
        .btn.primary {
            background: linear-gradient(135deg, var(--accent), #22d3ee);
            color: #fff;
            border-color: transparent
        }
        /* grid wrapper for slide animations */
        
        .grid-wrap {
            overflow: hidden
        }
        
        .grid {
            display: grid;
            gap: 12px;
            transition: transform var(--anim-ms) ease, opacity var(--anim-ms) ease
        }
        
        .cards {
            grid-template-columns: repeat(5, 1fr)
        }
        
        @media (max-width:1100px) {
            .cards {
                grid-template-columns: repeat(2, 1fr)
            }
        }
        
        @media (max-width:680px) {
            .cards {
                grid-template-columns: 1fr
            }
        }
        
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            min-height: 120px;
            opacity: 0;
            transform: translateY(8px);
            animation: cardIn .42s forwards;
        }
        
        @keyframes cardIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px
        }
        
        .day {
            font-weight: 700
        }
        
        .dateSmall {
            font-size: 13px;
            color: var(--muted)
        }
        
        .pair {
            border-radius: 10px;
            padding: 8px;
            margin: 6px 0;
            border: 1px solid rgba(255, 255, 255, .03);
            background: transparent;
            transition: transform .12s, border .18s, box-shadow .18s, opacity .12s
        }
        
        .pair .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 13px
        }
        
        .chip {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 999px
        }
        
        .lec {
            background: var(--lec);
            color: #fff
        }
        
        .prac {
            background: var(--prac);
            color: #000
        }
        
        .textpair {
            color: var(--muted);
            font-style: italic
        }
        
        .past {
            opacity: .55
        }
        /* highlights & pulsing on change */
        
        .card.now {
            outline: 3px solid rgba(14, 165, 233, .95);
            outline-offset: 3px;
            animation: pulseCard 2s infinite;
        }
        
        @keyframes pulseCard {
            0%,
            100% {
                outline-color: rgba(14, 165, 233, .7)
            }
            50% {
                outline-color: rgba(14, 165, 233, 1)
            }
        }
        
        .pair.current {
            border: 2px solid rgba(59, 130, 246, .95);
            box-shadow: 0 10px 30px rgba(59, 130, 246, .06);
            animation: pulseBlue 2.2s infinite;
        }
        
        @keyframes pulseBlue {
            0%,
            100% {
                box-shadow: 0 6px 18px rgba(59, 130, 246, .36)
            }
            50% {
                box-shadow: 0 14px 36px rgba(59, 130, 246, .65)
            }
        }
        
        .pair.next {
            border: 2px solid rgba(245, 158, 11, .95);
            box-shadow: 0 10px 30px rgba(245, 158, 11, .06);
            animation: pulseYellow 2.2s infinite;
            position: relative;
        }
        
        .pair.next .badge {
            position: absolute;
            right: 8px;
            top: 8px;
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 12px;
            background: rgba(255, 255, 255, .03);
            color: var(--text)
        }
        
        @keyframes pulseYellow {
            0%,
            100% {
                box-shadow: 0 6px 18px rgba(245, 158, 11, .36)
            }
            50% {
                box-shadow: 0 14px 36px rgba(245, 158, 11, .65)
            }
        }
        
        .pair.upcoming {
            border: 2px solid var(--green);
            animation: pulseGreen 2.2s infinite;
        }
        
        @keyframes pulseGreen {
            0%,
            100% {
                box-shadow: 0 6px 18px rgba(16, 163, 74, .36)
            }
            50% {
                box-shadow: 0 14px 36px rgba(16, 163, 74, .65)
            }
        }
        /* small util */
        
        .hidden {
            display: none
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0
        }
    </style>
</head>

<body data-theme="dark">
    <div class="wrap">
        <div class="topbar" role="banner">
            <div>
                <div class="brand">–†–æ–∑–∫–ª–∞–¥ ‚Äî 4 –∫—É—Ä—Å, –≥—Ä—É–ø–∞ –í</div>
                <div class="muted">–î–≤–æ—Ç–∏–∂–Ω–µ–≤–∏–π ‚Ä¢ –ü–Ω‚Äì–ü—Ç</div>
            </div>

            <div style="display:flex;gap:10px;align-items:center">
                <button id="toggleTheme" class="btn" title="–¢–µ–º–∞">–¢–µ–º–∞</button>
                <button id="todayBtn" class="btn" title="–°—å–æ–≥–æ–¥–Ω—ñ">–°—å–æ–≥–æ–¥–Ω—ñ</button>

                <div class="controls" role="navigation" aria-label="–¢–∏–∂–¥–µ–Ω—å">
                    <button id="prevWeek" class="btn" aria-label="–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ç–∏–∂–¥–µ–Ω—å">‚óÄ</button>
                    <div style="min-width:110px;text-align:center"><strong id="weekLabel">–ù–∏–∂–Ω—ñ–π</strong>
                        <div id="weekRange" class="muted" style="font-size:12px"></div>
                    </div>
                    <button id="nextWeek" class="btn" aria-label="–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ç–∏–∂–¥–µ–Ω—å">‚ñ∂</button>
                </div>
            </div>
        </div>

        <div class="grid-wrap" style="margin-top:12px">
            <div id="weekGrid" class="grid cards" aria-live="polite"></div>
        </div>
    </div>

    <script>
        /* ========= DATA ========== */
        /* DAYS */
        const DAYS = ['mon', 'tue', 'wed', 'thu', 'fri'];
        const DAY_NAMES = {
            mon: '–ü–Ω',
            tue: '–í—Ç',
            wed: '–°—Ä',
            thu: '–ß—Ç',
            fri: '–ü—Ç'
        };

        /* default schedule data (complete) */
        const defaultData = {
            settings: {
                theme: 'dark',
                baseTopWeekISO: '2025-09-01'
            },
            // times array (base times). We will apply monday shift on display.
            times: [{
                    start: '08:00',
                    end: '09:20'
                }, // index 0 -> 1st if used
                {
                    start: '09:30',
                    end: '10:50'
                }, // index 1 -> 2nd
                {
                    start: '11:00',
                    end: '12:20'
                }, // 3
                {
                    start: '12:40',
                    end: '14:00'
                }, // 4
                {
                    start: '14:10',
                    end: '15:30'
                }, // 5
                {
                    start: '15:40',
                    end: '17:00'
                }, // 6
                {
                    start: '17:10',
                    end: '18:30'
                } // 7 (reserve)
            ],
            template: {
                top: {
                    mon: [
                        null, {
                            type: 'lec',
                            title: '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–µ —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–æ',
                            teacher: '–°—É—à–∫–æ –û.–û.',
                            place: '–°–æ–±–æ—Ä–Ω–∞, 48'
                        }, {
                            type: 'lec',
                            title: '–ì–æ—Å–ø–æ–¥–∞—Ä—Å—å–∫–µ –ø—Ä–∞–≤–æ',
                            teacher: '–ö–∞–ª–∞—á–µ–Ω–∫–æ–≤–∞ –ö.–û.',
                            place: '304'
                        }, {
                            type: 'lec',
                            title: '–ö—Ä–∏–º—ñ–Ω–∞–ª—ñ—Å—Ç–∏–∫–∞',
                            teacher: '–ö–∞–≤—É–Ω –°.–ú.',
                            place: '313'
                        }
                    ],
                    tue: [
                        null, null, null, null, {
                            type: 'lec',
                            title: '–°–û–ü ‚Äî –õ—ñ–¥–µ—Ä—Å—Ç–≤–æ —Ç–∞ –∫–æ–º–∞–Ω–¥–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è',
                            teacher: '–°–µ—Ä–µ–¥–∞ –ì.–í.',
                            place: 'MS Teams'
                        }, {
                            type: 'prac',
                            title: '–°–û–ü ‚Äî –õ—ñ–¥–µ—Ä—Å—Ç–≤–æ —Ç–∞ –∫–æ–º–∞–Ω–¥–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è',
                            teacher: '–°–µ—Ä–µ–¥–∞ –ì.–í.',
                            place: 'MS Teams'
                        }
                    ],
                    wed: [
                        null, {
                            type: 'text',
                            title: '–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞ –∑ –ø–µ—Ä–µ–ª—ñ–∫—É'
                        }
                    ],
                    thu: [
                        null, null, null, {
                            type: 'lec',
                            title: '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–µ –ø—Ä–∞–≤–æ',
                            teacher: '–î–æ—Ä–æ—à–µ–Ω–∫–æ –õ.–ú.',
                            place: '304'
                        }, // 4
                        {
                            type: 'lec',
                            title: '–ó–µ–º–µ–ª—å–Ω–µ –ø—Ä–∞–≤–æ',
                            teacher: '–ë–∞—Ö—É—Ä –û.–í.',
                            place: '305'
                        }, // 5
                        {
                            type: 'lec',
                            title: '–§—ñ–Ω–∞–Ω—Å–æ–≤–µ –ø—Ä–∞–≤–æ',
                            teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ì.–û.',
                            place: '305'
                        } // 6
                    ],
                    fri: [
                        null, {
                            type: 'prac',
                            title: '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–µ —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–æ',
                            teacher: '–°—É—à–∫–æ –û.–û.',
                            place: '–°–æ–±–æ—Ä–Ω–∞, 48'
                        }, //2
                        {
                            type: 'prac',
                            title: '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–µ –ø—Ä–∞–≤–æ',
                            teacher: '–î–æ—Ä–æ—à–µ–Ω–∫–æ –õ.–ú.',
                            place: '121'
                        }, //3
                        {
                            type: 'prac',
                            title: '–§—ñ–Ω–∞–Ω—Å–æ–≤–µ –ø—Ä–∞–≤–æ',
                            teacher: '–ü–µ—Ç—Ä–µ–Ω–∫–æ –ì.–û.',
                            place: '305'
                        }, //4
                        {
                            type: 'prac',
                            title: '–ö—Ä–∏–º—ñ–Ω–∞–ª—ñ—Å—Ç–∏–∫–∞',
                            teacher: '–ö–∞–≤—É–Ω –°.–ú.',
                            place: '313'
                        } //5
                    ]
                },
                bottom: {
                    mon: [
                        null, {
                            type: 'lec',
                            title: '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–µ —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–æ',
                            teacher: '–°—É—à–∫–æ –û.–û.',
                            place: '–°–æ–±–æ—Ä–Ω–∞, 48'
                        }, {
                            type: 'lec',
                            title: '–ì–æ—Å–ø–æ–¥–∞—Ä—Å—å–∫–µ –ø—Ä–∞–≤–æ',
                            teacher: '–ö–∞–ª–∞—á–µ–Ω–∫–æ–≤–∞ –ö.–û.',
                            place: '304'
                        }
                    ],
                    tue: [
                        null, null, null, null, {
                            type: 'lec',
                            title: '–°–û–ü ‚Äî –õ—ñ–¥–µ—Ä—Å—Ç–≤–æ —Ç–∞ –∫–æ–º–∞–Ω–¥–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è',
                            teacher: '–°–µ—Ä–µ–¥–∞ –ì.–í.',
                            place: 'MS Teams'
                        }, {
                            type: 'prac',
                            title: '–°–û–ü ‚Äî –õ—ñ–¥–µ—Ä—Å—Ç–≤–æ —Ç–∞ –∫–æ–º–∞–Ω–¥–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è',
                            teacher: '–°–µ—Ä–µ–¥–∞ –ì.–í.',
                            place: 'MS Teams'
                        }
                    ],
                    wed: [
                        null, {
                            type: 'text',
                            title: '–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞ –∑ –ø–µ—Ä–µ–ª—ñ–∫—É'
                        }
                    ],
                    thu: [
                        null, null, null, {
                            type: 'lec',
                            title: '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–µ –ø—Ä–∞–≤–æ',
                            teacher: '–î–æ—Ä–æ—à–µ–Ω–∫–æ –õ.–ú.',
                            place: '304'
                        }, {
                            type: 'lec',
                            title: '–ó–µ–º–µ–ª—å–Ω–µ –ø—Ä–∞–≤–æ',
                            teacher: '–ë–∞—Ö—É—Ä –û.–í.',
                            place: '305'
                        }, {
                            type: 'prac',
                            title: '–ó–µ–º–µ–ª—å–Ω–µ –ø—Ä–∞–≤–æ',
                            teacher: '–ë–∞—Ö—É—Ä –û.–í.',
                            place: '307'
                        } // practice slot
                    ],
                    fri: [
                        null, {
                            type: 'prac',
                            title: '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–µ —Å—É–¥–æ—á–∏–Ω—Å—Ç–≤–æ',
                            teacher: '–°—É—à–∫–æ –û.–û.',
                            place: '–°–æ–±–æ—Ä–Ω–∞, 48'
                        }, {
                            type: 'prac',
                            title: '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–µ –ø—Ä–∞–≤–æ',
                            teacher: '–î–æ—Ä–æ—à–µ–Ω–∫–æ –õ.–ú.',
                            place: '121'
                        }, {
                            type: 'prac',
                            title: '–ì–æ—Å–ø–æ–¥–∞—Ä—Å—å–∫–µ –ø—Ä–∞–≤–æ',
                            teacher: '–ö–∞–ª–∞—á–µ–Ω–∫–æ–≤–∞ –ö.–û.',
                            place: '121'
                        }
                    ]
                }
            }
        };

        /* ========= HELPERS ========== */
        function mondayOf(date) {
            const d = new Date(date);
            const day = (d.getDay() + 6) % 7; // Monday as 0
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function sameDay(a, b) {
            return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
        }

        function parseHMToDate(hm, baseDate) {
            if (!hm) return null;
            const parts = hm.split(':').map(x => Number(x));
            if (!Number.isFinite(parts[0])) return null;
            const d = new Date(baseDate);
            d.setHours(parts[0], parts[1] || 0, 0, 0);
            return d;
        }

        function isTopWeek(date) {
            const base = mondayOf(new Date(defaultData.settings.baseTopWeekISO || '2025-09-01'));
            const cur = mondayOf(date);
            const diffWeeks = Math.round((cur - base) / (7 * 24 * 3600 * 1000));
            return diffWeeks % 2 === 0;
        }

        /* monday shift: for monday, indices >=1 use times[idx+1] */
        function getTimeFor(dayKey, pairIndex) {
            let idx = pairIndex;
            if (dayKey === 'mon' && pairIndex >= 1) idx = pairIndex + 1;
            return defaultData.times[idx] || {
                start: '',
                end: ''
            };
        }

        /* pairs template getter */
        function getPairsForDay(dayKey, date) {
            const week = isTopWeek(date) ? 'top' : 'bottom';
            const tpl = defaultData.template[week] && defaultData.template[week][dayKey] ? defaultData.template[week][dayKey] : [];
            return tpl.slice(); // clone
        }

        /* ========= RENDER & LOGIC ========= */
        const grid = document.getElementById('weekGrid');
        let currentMonday = mondayOf(new Date());
        let nextUpdateTimer = null;

        function formatDateShort(d) {
            return d.toLocaleDateString('uk-UA', {
                day: '2-digit',
                month: '2-digit'
            });
        }

        function updateWeekRangeLabel() {
            const start = new Date(currentMonday);
            const end = new Date(currentMonday.getTime() + 4 * 86400000);
            const rangeEl = document.getElementById('weekRange');
            rangeEl.textContent = `${start.toLocaleDateString('uk-UA',{day:'2-digit',month:'2-digit'})} ‚Äî ${end.toLocaleDateString('uk-UA',{day:'2-digit',month:'2-digit'})}`;
        }

        function render(withStagger = true) {
            // clear existing
            grid.innerHTML = '';
            updateWeekRangeLabel();
            const top = isTopWeek(currentMonday);
            document.getElementById('weekLabel').textContent = top ? '–í–µ—Ä—Ö–Ω—ñ–π' : '–ù–∏–∂–Ω—ñ–π';

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const viewingCurrentWeek = mondayOf(today).getTime() === currentMonday.getTime();

            for (let i = 0; i < DAYS.length; i++) {
                const dayKey = DAYS[i];
                const dayDate = new Date(currentMonday.getTime() + i * 86400000);
                const card = document.createElement('div');
                card.className = 'card';
                if (withStagger) card.style.animationDelay = `${i*0.07}s`;
                // header
                const head = document.createElement('div');
                head.className = 'head';
                head.innerHTML = `<div><div class="day">${DAY_NAMES[dayKey]}</div><div class="dateSmall">${formatDateShort(dayDate)}</div></div>`;
                card.appendChild(head);

                // collect pairs (only non-null)
                const pairs = getPairsForDay(dayKey, dayDate).map((p, idx) => ({
                    p,
                    idx
                })).filter(x => x.p);
                if (pairs.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'muted';
                    empty.textContent = '–í—ñ–ª—å–Ω–∏–π –¥–µ–Ω—å üéâ';
                    card.appendChild(empty);
                    grid.appendChild(card);
                    continue;
                }

                // compute current/next/upcoming only when viewing current week & same day
                let currentIdx = -1,
                    nextIdx = -1;
                if (viewingCurrentWeek && sameDay(dayDate, today)) {
                    // find current
                    for (const v of pairs) {
                        const t = getTimeFor(dayKey, v.idx);
                        const st = parseHMToDate(t.start, now);
                        const en = parseHMToDate(t.end, now);
                        if (st && en && now >= st && now <= en) {
                            currentIdx = v.idx;
                            break;
                        }
                    }
                    if (currentIdx !== -1) {
                        for (const v of pairs) {
                            if (v.idx > currentIdx) {
                                nextIdx = v.idx;
                                break;
                            }
                        }
                    } else {
                        for (const v of pairs) {
                            const t = getTimeFor(dayKey, v.idx);
                            const st = parseHMToDate(t.start, now);
                            if (st && st > now) {
                                nextIdx = v.idx;
                                break;
                            }
                        }
                    }
                }

                // render pairs
                for (const v of pairs) {
                    const p = v.p;
                    const idx = v.idx;
                    const t = getTimeFor(dayKey, idx);
                    const box = document.createElement('div');
                    box.className = 'pair';
                    // attach data
                    box.dataset.day = dayKey;
                    box.dataset.index = String(idx);

                    // states (only for today)
                    if (viewingCurrentWeek && sameDay(dayDate, today)) {
                        const st = parseHMToDate(t.start, now);
                        const en = parseHMToDate(t.end, now);
                        if (en && now > en) box.classList.add('past');
                        if (idx === currentIdx) box.classList.add('current');
                        if (idx === nextIdx && currentIdx !== -1) box.classList.add('next');
                        if (idx === nextIdx && currentIdx === -1) box.classList.add('upcoming');
                    }

                    const chip = p.type === 'lec' ? `<span class="chip lec">–õ–µ–∫—Ü—ñ—è</span>` :
                        p.type === 'prac' ? `<span class="chip prac">–ü—Ä–∞–∫—Ç–∏–∫–∞</span>` :
                        `<span class="chip textpair">–Ü–Ω—Ñ–æ</span>`;

                    box.innerHTML = `<div class="meta"><div>${t.start||''}‚Äì${t.end||''}</div>${chip}</div>
                       <h4>${escapeHtml(p.title)}</h4>
                       <div class="muted">${escapeHtml(p.teacher||'')}${p.place?(' ‚Ä¢ '+escapeHtml(p.place)) : ''}</div>`;

                    if (box.classList.contains('next')) {
                        const badge = document.createElement('div');
                        badge.className = 'badge';
                        badge.textContent = '–ù–∞—Å—Ç—É–ø–Ω–∞';
                        box.appendChild(badge);
                    }

                    card.appendChild(box);
                }

                // apply .now to card for today (for outline/pulse)
                if (viewingCurrentWeek && sameDay(dayDate, today)) card.classList.add('now');

                grid.appendChild(card);
            }

            // autoscroll to today's card if viewing current week
            if (viewingCurrentWeek) {
                setTimeout(() => {
                    const todayCard = Array.from(document.querySelectorAll('.card')).find(c => c.classList.contains('now'));
                    if (todayCard) todayCard.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }, 120);
            }

            // schedule next precise update
            scheduleNextPreciseUpdate();
        }

        /* escape HTML */
        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        /* ========== Precise scheduling of next change ==========
           Find the next interesting timestamp (start or end of any pair today),
           or midnight start of next day if none -> setTimeout to that exact time.
        */
        function scheduleNextPreciseUpdate() {
            if (nextUpdateTimer) {
                clearTimeout(nextUpdateTimer);
                nextUpdateTimer = null;
            }
            const now = new Date();
            const todayKey = DAYS[(now.getDay() + 6) % 7]; // map Sun..Sat => Mon..Sun shift
            // if today not in our DAYS (i.e., weekend), schedule to next Monday 00:01
            if (!todayKey) {
                const nextDay = new Date(now);
                nextDay.setDate(now.getDate() + 1);
                nextDay.setHours(0, 1, 0, 0);
                nextUpdateTimer = setTimeout(() => render(false), nextDay.getTime() - now.getTime());
                return;
            }

            // collect candidate times (start & end of pairs today)
            const candidates = [];
            const pairs = getPairsForDay(todayKey, now);
            pairs.forEach((p, idx) => {
                if (!p) return;
                const t = getTimeFor(todayKey, idx);
                if (t.start) {
                    const st = parseHMToDate(t.start, now);
                    if (st && st.getTime() > now.getTime()) candidates.push(st);
                }
                if (t.end) {
                    const en = parseHMToDate(t.end, now);
                    if (en && en.getTime() > now.getTime()) candidates.push(en);
                }
            });

            // also consider next day's 00:00+1min if no other candidate
            if (candidates.length === 0) {
                const nextDay = new Date(now);
                nextDay.setDate(now.getDate() + 1);
                nextDay.setHours(0, 1, 0, 0);
                candidates.push(nextDay);
            }

            // pick earliest candidate
            candidates.sort((a, b) => a.getTime() - b.getTime());
            const next = candidates[0];
            if (!next) return;
            const delay = Math.max(200, next.getTime() - now.getTime()); // at least tiny delay
            nextUpdateTimer = setTimeout(() => {
                // when time comes -> re-render which will update highlights, then schedule again
                render(false);
            }, delay);
        }

        /* ========= Navigation & swipe + animations ========= */
        const ANIM_MS = 360;
        let animating = false;

        function changeWeekAnimated(direction) { // direction: -1 prev, +1 next
            if (animating) return;
            animating = true;
            const g = grid;
            // animate out
            g.style.transition = `transform ${ANIM_MS}ms ease, opacity ${ANIM_MS}ms ease`;
            g.style.transform = `translateX(${direction>0 ? '-30px' : '30px'})`;
            g.style.opacity = '0';
            setTimeout(() => {
                currentMonday.setDate(currentMonday.getDate() + direction * 7);
                // re-render content (no stagger needed -> keep true for nice effect)
                render(true);
                // reset transform to incoming
                g.style.transition = 'none';
                g.style.transform = `translateX(${direction>0 ? '30px' : '-30px'})`;
                g.style.opacity = '0';
                requestAnimationFrame(() => {
                    g.style.transition = `transform ${ANIM_MS}ms ease, opacity ${ANIM_MS}ms ease`;
                    g.style.transform = 'translateX(0)';
                    g.style.opacity = '1';
                    setTimeout(() => {
                        animating = false;
                    }, ANIM_MS + 20);
                });
            }, ANIM_MS + 10);
        }

        /* buttons */
        document.getElementById('prevWeek').addEventListener('click', () => changeWeekAnimated(-1));
        document.getElementById('nextWeek').addEventListener('click', () => changeWeekAnimated(1));
        document.getElementById('todayBtn').addEventListener('click', () => {
            currentMonday = mondayOf(new Date());
            render(true);
        });

        /* theme */
        document.getElementById('toggleTheme').addEventListener('click', () => {
            const cur = document.body.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
            const next = cur === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', next);
            // keep in data.settings (not persisted here) if needed later
            defaultData.settings.theme = next;
        });

        /* swipe for mobile */
        let touchStartX = 0,
            touchStartY = 0;
        document.addEventListener('touchstart', e => {
            if (e.changedTouches && e.changedTouches[0]) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }
        }, {
            passive: true
        });
        document.addEventListener('touchend', e => {
            if (!e.changedTouches || !e.changedTouches[0]) return;
            const dx = e.changedTouches[0].screenX - touchStartX;
            const dy = e.changedTouches[0].screenY - touchStartY;
            if (Math.abs(dx) < 60 || Math.abs(dy) > Math.abs(dx)) return;
            if (dx > 0) changeWeekAnimated(-1);
            else changeWeekAnimated(1);
        }, {
            passive: true
        });

        /* initial render */
        render(true);

        /* Register service worker quietly (if you add sw.js later) */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => { /* ignore errors */ });
        }
    </script>
</body>

</html>