<!doctype html>
<html lang="uk">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Розклад — 4 курс, група В</title>
    <meta name="theme-color" content="#0ea5e9" />
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
         :root {
            --bg: #0b1220;
            --panel: #0e1726;
            --text: #e5eefb;
            --muted: #a9b8d5;
            --accent: #0ea5e9;
            --card: #0f172a;
            --border: #1f2a44;
            --lec: #3b82f6;
            --prac: #facc15;
            --ok: #16a34a;
        }
        
        [data-theme="light"] {
            --bg: #f8fafc;
            --panel: #fff;
            --text: #0b1220;
            --muted: #54627a;
            --card: #fff;
            --border: #e2e8f0;
        }
        
        * {
            box-sizing: border-box
        }
        
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font: 15px/1.4 system-ui, -apple-system, 'Segoe UI', Roboto, Inter, sans-serif
        }
        
        .wrap {
            max-width: 1150px;
            margin: 0 auto;
            padding: 12px
        }
        
        .topbar {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, var(--bg) 85%, transparent);
            padding: 8px 0;
            z-index: 30
        }
        
        .brand {
            font-weight: 800
        }
        
        .btn {
            border: 1px solid var(--border);
            background: var(--panel);
            color: var(--text);
            padding: 7px 12px;
            border-radius: 12px;
            cursor: pointer;
            margin-left: 6px;
            transition: transform .12s
        }
        
        .btn:active {
            transform: scale(.98)
        }
        
        .btn.primary {
            background: linear-gradient(135deg, var(--accent), #22d3ee);
            color: #fff;
            border-color: transparent
        }
        
        .muted {
            color: var(--muted);
            font-size: 13px
        }
        
        .grid {
            display: grid;
            gap: 10px
        }
        
        .cards {
            grid-template-columns: repeat(5, 1fr)
        }
        
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            min-height: 120px;
            scroll-margin: 90px
        }
        
        .card.today {
            outline: 3px solid rgba(14, 165, 233, .85);
            outline-offset: 6px
        }
        
        .pair {
            border-radius: 10px;
            padding: 8px;
            margin: 6px 0;
            border: 1px solid var(--border);
            background: transparent;
            transition: box-shadow .12s, outline .12s
        }
        
        .pair.current {
            outline: 3px solid rgba(59, 130, 246, .95);
            outline-offset: 4px
        }
        
        .pair.next {
            outline: 3px solid rgba(22, 163, 74, .95);
            outline-offset: 4px
        }
        
        .pair .meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px
        }
        
        .chip {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 999px
        }
        
        .lec {
            background: var(--lec);
            color: #fff
        }
        
        .prac {
            background: var(--prac);
            color: #000
        }
        
        h4 {
            margin: 2px 0;
            font-size: 14px
        }
        
        @media(max-width:1100px) {
            .cards {
                grid-template-columns: repeat(2, 1fr)
            }
        }
        
        @media(max-width:680px) {
            .cards {
                grid-template-columns: repeat(1, 1fr)
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="topbar">
            <div>
                <div class="brand">Розклад — 4 курс, група В</div>
                <div class="muted">Двотижневий (верхній/нижній)</div>
            </div>
            <div>
                <button id="toggleTheme" class="btn">Тема</button>
                <button id="todayBtn" class="btn">Сьогодні</button>
                <span style="display:inline-flex;align-items:center;background:var(--panel);padding:6px;border-radius:10px;border:1px solid var(--border);margin-left:8px">
          <button id="prevWeek" class="btn">◀</button>
          <strong id="weekLabel" style="padding:0 8px">Нижній</strong>
          <button id="nextWeek" class="btn">▶</button>
        </span>
            </div>
        </div>

        <div id="weekGrid" class="grid cards" aria-live="polite"></div>
    </div>

    <script>
        /* ---------- HELPERS: local date handling (avoid UTC shift) ---------- */
        function pad(n) {
            return n < 10 ? '0' + n : '' + n;
        }

        function localISO(d) {
            return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate());
        }

        function parseLocalISO(s) {
            if (!s) return null;
            const p = s.split('-').map(x => parseInt(x, 10));
            if (p.length < 3 || !Number.isFinite(p[0])) return null;
            return new Date(p[0], (p[1] || 1) - 1, p[2] || 1, 0, 0, 0, 0);
        }

        function mondayOf(date) {
            const d = new Date(date);
            const day = (d.getDay() + 6) % 7;
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function parseTimeToDate(timeStr, baseDate) {
            if (!timeStr) return null;
            const [hh, mm] = ('' + timeStr).split(':').map(Number);
            if (!Number.isFinite(hh)) return null;
            return new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), hh, mm || 0, 0, 0);
        }

        /* ---------- DATA (use this as default; edit if you need) ---------- */
        /* I used the schedule as discussed in the conversation and the latest requested fixes for Thu/Fri */
        const STORAGE_KEY = 'rozklad.v_final';
        const defaultData = {
            settings: {
                theme: 'dark',
                baseTopWeekISO: '2025-09-01',
                perDay: 6
            },
            times: [{
                start: '08:00',
                end: '09:20'
            }, {
                start: '09:30',
                end: '10:50'
            }, {
                start: '11:00',
                end: '12:30'
            }, {
                start: '12:40',
                end: '14:10'
            }, {
                start: '14:20',
                end: '15:50'
            }, {
                start: '16:00',
                end: '17:30'
            }],
            template: {
                // TOP week
                top: {
                    mon: [
                        null, {
                            type: 'lec',
                            title: 'Адміністративне судочинство',
                            teacher: 'Сушко О.О.',
                            place: 'Соборна, 48'
                        }, {
                            type: 'lec',
                            title: 'Господарське право',
                            teacher: 'Калаченкова К.О.',
                            place: '304'
                        }, {
                            type: 'lec',
                            title: 'Криміналістика',
                            teacher: 'Кавун С.М.',
                            place: '313'
                        }
                    ],
                    tue: [
                        null, null, null, null, {
                            type: 'lec',
                            title: 'СОП — Лідерство та командоутворення',
                            teacher: 'Середа Г.В.',
                            place: 'MS Teams'
                        }, {
                            type: 'prac',
                            title: 'СОП — Лідерство та командоутворення',
                            teacher: 'Середа Г.В.',
                            place: 'MS Teams'
                        }
                    ],
                    wed: [null, {
                        type: 'text',
                        title: 'Дисципліна з переліку'
                    }],
                    thu: [
                        null, null, {
                            type: 'lec',
                            title: 'Корпоративне право',
                            teacher: 'Дорошенко Л.М.',
                            place: '304'
                        }, {
                            type: 'lec',
                            title: 'Земельне право',
                            teacher: 'Бахур О.В.',
                            place: '305'
                        }, {
                            type: 'lec',
                            title: 'Фінансове право',
                            teacher: 'Петренко Г.О.',
                            place: '305'
                        }
                    ],
                    fri: [
                        null, {
                            type: 'prac',
                            title: 'Адміністративне судочинство (практика)',
                            teacher: 'Сушко О.О.',
                            place: 'Соборна, 48'
                        }, {
                            type: 'prac',
                            title: 'Корпоративне право (практика)',
                            teacher: 'Дорошенко Л.М.',
                            place: '121'
                        }, {
                            type: 'prac',
                            title: 'Фінансове право (практика)',
                            teacher: 'Петренко Г.О.',
                            place: '305'
                        }, {
                            type: 'prac',
                            title: 'Криміналістика (практика)',
                            teacher: 'Кавун С.М.',
                            place: '313'
                        }
                    ]
                },
                // BOTTOM week
                bottom: {
                    mon: [
                        null, {
                            type: 'lec',
                            title: 'Адміністративне судочинство',
                            teacher: 'Сушко О.О.',
                            place: 'Соборна, 48'
                        }, {
                            type: 'lec',
                            title: 'Господарське право',
                            teacher: 'Калаченкова К.О.',
                            place: '304'
                        }
                    ],
                    tue: [
                        null, null, null, null, {
                            type: 'lec',
                            title: 'СОП — Лідерство та командоутворення',
                            teacher: 'Середа Г.В.',
                            place: 'MS Teams'
                        }, {
                            type: 'prac',
                            title: 'СОП — Лідерство та командоутворення',
                            teacher: 'Середа Г.В.',
                            place: 'MS Teams'
                        }
                    ],
                    wed: [null, {
                        type: 'text',
                        title: 'Дисципліна з переліку'
                    }],
                    thu: [
                        null, null, {
                            type: 'lec',
                            title: 'Корпоративне право',
                            teacher: 'Дорошенко Л.М.',
                            place: '304'
                        }, {
                            type: 'lec',
                            title: 'Земельне право',
                            teacher: 'Бахур О.В.',
                            place: '305'
                        }, {
                            type: 'prac',
                            title: 'Земельне право (практика)',
                            teacher: 'Бахур О.В.',
                            place: '307'
                        }
                    ],
                    fri: [
                        null, {
                            type: 'prac',
                            title: 'Адміністративне судочинство (практика)',
                            teacher: 'Сушко О.О.',
                            place: 'Соборна, 48'
                        }, {
                            type: 'prac',
                            title: 'Корпоративне право (практика)',
                            teacher: 'Дорошенко Л.М.',
                            place: '121'
                        }, {
                            type: 'prac',
                            title: 'Господарське право (практика)',
                            teacher: 'Калаченкова К.О.',
                            place: '304'
                        }
                    ]
                }
            },
            exceptions: {}
        };

        /* ---------- load/save (localStorage) ---------- */
        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : structuredClone(defaultData);
            } catch (e) {
                return structuredClone(defaultData);
            }
        }

        function saveData(d) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
        }
        let data = loadData();

        /* ---------- utilities ---------- */
        function isTopWeek(date) {
            const base = mondayOf(parseLocalISO(data.settings.baseTopWeekISO) || new Date());
            const cur = mondayOf(date);
            const diffWeeks = Math.round((cur - base) / (7 * 24 * 3600 * 1000));
            return diffWeeks % 2 === 0;
        }
        const DAYS = ['mon', 'tue', 'wed', 'thu', 'fri'];
        const DAY_NAMES = {
            mon: 'Пн',
            tue: 'Вт',
            wed: 'Ср',
            thu: 'Чт',
            fri: 'Пт'
        };

        /* ---------- rendering ---------- */
        const grid = document.getElementById('weekGrid');
        let currentMonday = mondayOf(new Date());

        function formatDateShort(d) {
            return d.toLocaleDateString('uk-UA', {
                day: '2-digit',
                month: '2-digit'
            });
        }

        function getPairsForDay(dayKey, date) {
            const week = isTopWeek(date) ? 'top' : 'bottom';
            return (data.template && data.template[week] && data.template[week][dayKey]) ? data.template[week][dayKey] : [];
        }

        function render() {
            grid.innerHTML = '';
            const top = isTopWeek(currentMonday);
            document.getElementById('weekLabel').textContent = top ? 'Верхній' : 'Нижній';

            const now = new Date();
            const todayISO = localISO(now);
            const viewingCurrentWeek = mondayOf(now).getTime() === currentMonday.getTime();

            let scrolled = false;

            for (let i = 0; i < DAYS.length; i++) {
                const dayKey = DAYS[i];
                const card = document.createElement('div');
                card.className = 'card';

                // local day date
                const dayDate = new Date(currentMonday.getFullYear(), currentMonday.getMonth(), currentMonday.getDate() + i, 0, 0, 0, 0);
                if (localISO(dayDate) === todayISO && viewingCurrentWeek) {
                    card.classList.add('today');
                }

                const head = document.createElement('div');
                head.className = 'head';
                head.innerHTML = `<div class="day">${DAY_NAMES[dayKey]}</div><div class="muted">${formatDateShort(dayDate)}</div>`;
                card.appendChild(head);

                const pairs = getPairsForDay(dayKey, dayDate) || [];
                // collect visible indices (only those with data)
                const visibleIdx = [];
                for (let j = 0; j < Math.max(pairs.length, data.settings.perDay); j++) {
                    if (pairs[j]) visibleIdx.push(j);
                }

                if (visibleIdx.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'muted';
                    empty.textContent = 'Вільний день 🎉';
                    card.appendChild(empty);
                } else {
                    // determine current and next for this day (only when viewing current week)
                    let currentIdx = -1;
                    let nextIdx = -1;
                    if (viewingCurrentWeek && localISO(dayDate) === todayISO) {
                        // find current
                        for (const j of visibleIdx) {
                            const t = data.times[j];
                            if (!t || !t.start || !t.end) continue;
                            const st = parseTimeToDate(t.start, dayDate);
                            const en = parseTimeToDate(t.end, dayDate);
                            if (st && en && now >= st && now < en) {
                                currentIdx = j;
                                break;
                            }
                        }
                        if (currentIdx >= 0) {
                            // next is the next visible index > currentIdx
                            for (const j of visibleIdx) {
                                if (j > currentIdx) {
                                    nextIdx = j;
                                    break;
                                }
                            }
                        } else {
                            // no current -> the nearest future slot today
                            for (const j of visibleIdx) {
                                const t = data.times[j];
                                if (!t || !t.start) continue;
                                const st = parseTimeToDate(t.start, dayDate);
                                if (st && st > now) {
                                    nextIdx = j;
                                    break;
                                }
                            }
                        }
                    }

                    // render visible slots in order
                    for (const j of visibleIdx) {
                        const p = pairs[j];
                        const time = data.times[j] || {
                            start: '',
                            end: ''
                        };
                        const box = document.createElement('div');
                        box.className = 'pair';

                        if (j === currentIdx) box.classList.add('current');
                        else if (j === nextIdx) box.classList.add('next');

                        let chip = '';
                        if (p.type === 'lec') chip = `<span class="chip lec">Лекція</span>`;
                        else if (p.type === 'prac') chip = `<span class="chip prac">Практика</span>`;
                        else chip = `<span class="chip">${p.type || 'Інфо'}</span>`;

                        box.innerHTML = `<div class="meta"><div>${time.start||''}–${time.end||''}</div>${chip}</div>
                         <h4>${escapeHtml(p.title||'')}</h4>
                         <div class="muted">${escapeHtml(p.teacher||'')}${p.place?(' • '+escapeHtml(p.place)) : ''}</div>`;
                        card.appendChild(box);
                    }
                }

                grid.appendChild(card);

                // autoscroll to today once (only if viewing current week)
                if (!scrolled && viewingCurrentWeek && card.classList.contains('today')) {
                    // small timeout to let layout stabilize
                    setTimeout(() => {
                        card.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }, 80);
                    scrolled = true;
                }
            }
        }

        /* ---------- small helpers ---------- */
        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        /* ---------- navigation & theme ---------- */
        document.getElementById('prevWeek').addEventListener('click', () => {
            currentMonday.setDate(currentMonday.getDate() - 7);
            render();
        });
        document.getElementById('nextWeek').addEventListener('click', () => {
            currentMonday.setDate(currentMonday.getDate() + 7);
            render();
        });
        document.getElementById('todayBtn').addEventListener('click', () => {
            currentMonday = mondayOf(new Date());
            render();
        });
        document.getElementById('toggleTheme').addEventListener('click', () => {
            data.settings.theme = (data.settings.theme === 'light') ? 'dark' : 'light';
            document.body.setAttribute('data-theme', data.settings.theme === 'light' ? 'light' : 'dark');
            saveData(data);
        });

        /* ---------- start ---------- */
        document.body.setAttribute('data-theme', data.settings.theme === 'light' ? 'light' : 'dark');
        render();

        /* register service worker quietly (if presentF) */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => { /* ignore */ });
        }
    </script>
</body>

</html>